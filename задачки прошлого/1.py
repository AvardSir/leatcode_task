import pandas as pd
from openpyxl import load_workbook
from openpyxl.utils.dataframe import dataframe_to_rows

# Чтение из Excel
df = pd.read_excel("production_res_valid_only copy.xlsx", skiprows=2, engine="openpyxl")

# Переименуем колонки для удобства (если названия могут отличаться — поправь)
df = df.rename(columns={
    'Предприятие': 'Полное наименование',
    'ИНН': 'ИНН',
    'Дата внесения в реестр': 'Дата выдачи',
    'Срок действия': 'Дата окончания действия',
    'ОКПД2': 'ОКПД2'
})

# Уберем лишние столбцы, оставим только нужные
df = df[['Полное наименование', 'ИНН', 'Дата выдачи', 'Дата окончания действия', 'ОКПД2']].copy()

# Добавим пустые колонки для остальных полей
df['Компания'] = ''  # если хочешь продублировать — можно = df['Полное наименование']
df['Сфера'] = ''
df['Расшифровка ОКПД2'] = ''
df['Количество российской продукции, шт.'] = ''
df['Статус'] = ''

# Переупорядочим колонки
df = df[['Компания', 'Полное наименование', 'ИНН', 'Дата выдачи',
         'Дата окончания действия', 'Сфера', 'ОКПД2', 'Расшифровка ОКПД2',
         'Количество российской продукции, шт.', 'Статус']]

# Сортировка для группировки
df.sort_values(by=['ИНН', 'Полное наименование'], inplace=True)

# Эмуляция объединения ячеек — удаляем дубликаты для отображения
df_display = df.copy()
prev_inn = None
prev_name = None
for i, row in df_display.iterrows():
    if row['ИНН'] == prev_inn and row['Полное наименование'] == prev_name:
        df_display.at[i, 'Полное наименование'] = ''
        df_display.at[i, 'ИНН'] = ''
    else:
        prev_inn = row['ИНН']
        prev_name = row['Полное наименование']

# Сохраняем в Excel
output_file = "сводка_по_компаниям.xlsx"
df_display.to_excel(output_file, index=False)

print(f"✅ Сохранено: {output_file}")
